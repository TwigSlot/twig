<!DOCTYPE>

<html>

  <head>
    <title>The Web is Great</title>

    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">

    <style>
      body {
        font-family: helvetica;
        font-size: 14px;
      }
      h1 {
        opacity: 0.5;
        font-size: 1em;
      }
      .link {
        fill: none;
        stroke: #000;
        stroke-opacity: .2;
      }
      .link:hover {
        stroke-opacity: .5;
      }
      .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 0%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: white; /* Fallback color */
        background-color: rgba(0,0,0,0.2); /* Black w/ opacity */
      }

      /* Modal Content */
      .modal-content {
        position: fixed;
        bottom: 0;
        background-color: #fefefe;
        width: 100%;
      }
      .modal-header {
        padding: 2px 16px;
        background-color: #5cb85c;
        color: white;
      }
      
      .modal-body {padding: 2px 16px;}
      
      .modal-footer {
        padding: 2px 16px;
        background-color: #5cb85c;
        color: white;
      }

    </style>
    <script src="https://unpkg.com/d3-array@1"></script>
    <script src="https://unpkg.com/d3-collection@1"></script>
    <script src="https://unpkg.com/d3-path@1"></script>
    <script src="https://unpkg.com/d3-shape@1"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3"></script>
    <script src="https://unpkg.com/d3-selection@3"></script>
    <script src="https://unpkg.com/d3-request@1.0.6"></script>
    <script src="https://unpkg.com/d3-dispatch@3.0.1"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script>
      function onload(){
        var margin = { top: 10, right: 10, bottom: 10, left: 10 };
        var width = 1450 - margin.left - margin.right;
        var height = 480 - margin.top - margin.bottom;
        var svg = d3.select("#graph").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
//        console.log(svg)
        var sankey = d3.sankey()
          .nodeWidth(36)
          .nodePadding(290)
          .size([width, height]);
          graph = {
            "nodes": [
              { "node": 0, "title": "node0", "guid": "blah1" },
              { "node": 1, "title": "node1", "guid": "blah2" },
              { "node": 2, "title": "node2", "guid": "blah3" },
              { "node": 3, "title": "node3", "guid": "blah4" },
              { "node": 4, "title": "node4", "guid": "blah5" },
              { "node": 5, "title": "node5", "guid": "blah6" },
            ],
            "links": [
              { "source": 0, "target": 2, "value": 2 },
              { "source": 1, "target": 2, "value": 2 },
              { "source": 1, "target": 3, "value": 2 },
              { "source": 0, "target": 4, "value": 2 },
              { "source": 2, "target": 3, "value": 2 },
              { "source": 3, "target": 5, "value": 3 },
              { "source": 2, "target": 4, "value": 2 },
              { "source": 3, "target": 4, "value": 4 },
              { "source": 4, "target": 5, "value": 4 },
            ]
          };
//          console.log(graph)
          // Constructs a new Sankey generator with the default settings.
          sankey({ nodes: graph.nodes, links: graph.links });

          // add in the links
//          console.log(sankey)
          var link = svg.append("g")
            .selectAll(".link")
            .data(graph.links)
            .enter()
            .append("path")
            .attr("class", "link")
            .attr("d", d3.sankeyLinkHorizontal())
            .style("stroke-width", function (d) { return 10 })
            .sort(function (a, b) { return Math.abs(b.y1-b.y0) - Math.abs(a.y1-a.y0); })
            .on("click", function(d){
              if(d3.event.defaultPrevented) console.log('huh');
              console.log('clicked', d.value);
            })

          // add in the nodes
          var node = svg.append("g")
            .selectAll(".node")
            .data(graph.nodes)
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", function (d) { return "translate(" + (d.x0) + "," + (d.y0) + ")"; })
//            .call(d3.drag()
//              .subject(function(d) { return d; })
//              .clickDistance(10)
//              .on("start", function() { this.parentNode.appendChild(this); })
//              .on("drag", dragmove))

          // add the rectangles for the nodes
          node
            .append("rect")
            .attr("height", function (d) { return Math.abs(d.y1-d.y0); })
            .attr("width", sankey.nodeWidth())
            .attr("class", "meow")
            .attr("id", function (d) { return d.guid; })
//            .style("fill", function (d) { return d.color = color(d.name.replace(/ .*/, "")); })
//            .style("stroke", function (d) { return d3.rgb(d.color).darker(2); })
            // Add hover text
            .append("title")

          // add in the title for the nodes
          node
            .append("text")
            .attr("x", -6)
            .attr("y", function (d) { return Math.abs(d.y1-d.y0) / 2; })
            .attr("dy", ".35em")
            .attr("text-anchor", "end")
            .attr("transform", null)
            .text(function (d) { return d.title; })
            .filter(function (d) { return d.x0 < width / 2; })
            .attr("x", 6 + sankey.nodeWidth())
            .attr("text-anchor", "start");

          // the function for moving the nodes
          function dragmove(d) {
            var rectY = d3.select(this).select("rect").attr("y");
            var rectX = d3.select(this).select("rect").attr("X");
            d.y0 = d.y0 + d3.event.dy;
            d.x1 = d.x1 + d3.event.dx;
            d.x0 = d.x0 + d3.event.dx;
            var yTranslate = d.y0 - rectY;
            var xTranslate = d.x0 - rectX;
            d3.select(this).attr('transform', "translate(" + (xTranslate) + "," + (yTranslate) + ")");
            sankey.update(graph);
            link.attr('d', d3.sankeyLinkHorizontal());
          }
          var rects = document.getElementsByClassName('meow');
          var modal = document.getElementById("myModal");
//          console.log(rects);
          for(var i=0; i<rects.length; i++){
//           console.log(rects[i]);
            rects[i].addEventListener('mouseover', e => {
//              console.log(e.target.id, "over");
              modal.style.display = "block";
            });
            rects[i].addEventListener('mouseout', e => {
//              console.log(e.target.id, "out");
              modal.style.display = "none";
            });
            rects[i].addEventListener('click', e => {
//              console.log(e.target.id, "click");
              location.href = "item.html?title=" + e.target.id
            });
          }
      }
    </script>
    <script src="tree.js"></script>
    <script>
      class Concept{
        constructor(title, guid){
          this.title = title
          this.guid = guid
        }
      }
      var concepts = {} // map from guid to Concept object
      var nameOfMindmap = ''
      var curTitle = ''
      var curGuid = ''
      function process(data){
        data = data.split(/\r\n|\r|\n/)
        data.forEach((line) => {
          line = line.split('//')[0];
          console.log(line)
          if(line.toLowerCase().search('name') != -1){
            var idx = line.search(':')
            nameOfMindmap = line.substr(idx+1, line.length-1)
            nameOfMindmap = nameOfMindmap.trimLeft()
            console.log(nameOfMindmap)
          }else if(line.toLowerCase().search('title') != -1){
            console.log('title')
            var idx = line.search(':')
            if(curTitle != '' && curGuid != ''){ curTitle = curGuid = '' }
            curTitle = line.substr(idx+1, line.length-1)
            curTitle = curTitle.trimLeft()
            if(curTitle != '' && curGuid != ''){ concepts[curGuid] = new Concept(curTitle,curGuid); }
            console.log(concepts)
          }else if(line.toLowerCase().search('guid') != -1){
            var idx = line.search(':')
            if(curTitle != '' && curGuid != ''){ curTitle = curGuid = '' }
            curGuid = line.substr(idx+1, line.length-1)
            curGuid = curGuid.trim()
            console.log(curGuid)
            if(curTitle != '' && curGuid != ''){ concepts[curGuid] = new Concept(curTitle,curGuid); }
            console.log(concepts)
          }else if(line.toLowerCase().search('summary') != -1){
          }else if(line.toLowerCase().search('prereq') != -1){
          }
        })
        document.getElementById('name').innerHTML = nameOfMindmap;
      }

      function load(url) {
        fetch(url).then(res => {
          return res.text();
        }).then(function(data){
          process(data);
        });
      }
      window.addEventListener('DOMContentLoaded', function(){
        load("http://raw.githubusercontent.com/tch1001/twig/main/qft.twig")
      });
    </script>
  </head>

  <body onload="onload()">
    <h1 id="name">The Web is Great (TWIG)</h1>
    <div id="graph"></div>
    <div id="myModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close">&times;</span>
        <h2>Modal Header</h2>
      </div>
      <div class="modal-body">
        <p>Some text in the Modal Body</p>
        <p>Some other text...</p>
      </div>
      <div class="modal-footer">
        <h3>Modal Footer</h3>
      </div>
    </div>
    
    </div>
  </body>

</html>
